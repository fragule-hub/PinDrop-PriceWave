## 现状与信号梳理
- PriceCalculator：在通过条件时发出 `GlobalSignal.coupon_is_passed(coupon)`，并发出 `price_change(index, price)`；在取消优惠券时发出 `price_labels_rebuild(from_index, new_steps)`，当重算失败时发出 `GlobalSignal.coupons_recalc_failed(coupons)`。
- CouponContainer：已连接 `coupon_is_passed/coupon_is_clicked/coupon_is_cancelled/coupon_is_failed/coupons_recalc_failed`，但失败相关处理留空。
- Battle：已在 `_ready()` 生成基础价格标签（原价/特价），尚未接入优惠券事件，未处理重算重建标签。
- PriceLabelMaker：具备单个和顺序生成能力，已有内部标签列表与“上一个标签禁用”逻辑。

## 改动概览
- 增强 PriceCalculator：新增“步骤文本”信号用于价格标签文案传递。
- 接入 Battle：连接计算器信号，创建/重建 PriceLabel。
- 扩展 PriceLabelMaker：添加“按起始序号释放标签”能力与索引映射。
- 完善 CouponContainer：处理重算失败与条件失败，更新优惠券状态与动画。
- 增强 Coupon：增加失败轻微左移后回弹动画函数。

## 详细实现步骤
### 1. PriceCalculator 增强
- 新增 `signal price_step_added(index: int, text: String, price: float)`。
- 在 `_on_coupon_is_clicked` 的 `can_pass` 分支中，计算 `eff_result` 后：
  - 维持原逻辑更新 `current_price/current_index/applied_steps/price_change`；
  - 组装文本 `formula`，发出 `price_step_added.emit(current_index, formula, current_price)`。
- 保持 `price_labels_rebuild(from_index, new_steps)` 原有结构，其中 `new_steps` 元素包含 `{index, price, formula}`。

### 2. Battle 接入信号与处理
- 在 `_ready()`：
  - 连接 `price_calculator.price_step_added` 到 `_on_price_step_added(index, text, price)`：
    - 调用 `price_label_maker.create_price_label({"num": index, "text": text})`。
  - 连接 `price_calculator.price_labels_rebuild` 到 `_on_price_labels_rebuild(from_index, new_steps)`：
    - 调用 `price_label_maker.remove_labels_from_index(from_index)` 释放需重建的标签；
    - 将 `new_steps` 映射为 `[{"num": s.index, "text": s.formula}]`；
    - 调用 `price_label_maker.create_price_labels_sequential(label_datas)` 顺序重建。

### 3. PriceLabelMaker 扩展
- 内部增加 `_label_index_map: Dictionary`，记录 `PriceLabel -> index`；创建时写入映射与 `_labels`。
- 新增 `remove_labels_from_index(start_index: int) -> void`：
  - 遍历 `_labels` 找到索引 `>= start_index` 的标签：`queue_free()`，从 `_labels` 与 `_label_index_map` 移除；
  - 重置 `_previous_label` 为剩余最后一个标签（若存在）。
- 保持“当前标签坠落结束时禁用上一个标签”的逻辑不变。

### 4. CouponContainer 失败处理
- `_on_coupon_failed(coupon: Coupon)`：调用 `coupon.play_fail_bump()` 以提示失败，不改变选择状态。
- `_on_coupons_recalc_failed(coupons: Array)`：
  - 找到第一个失败优惠券在 `_selected_coupons` 中的位置 `start_idx`；
  - 从 `start_idx` 到末尾依次：
    - 移除该序号的数字图标；
    - 调用 `coupon.move_back()` 与 `coupon.switch_to_base()`；
  - 将这些优惠券从 `_selected_coupons` 中移除；
  - 重新为剩余优惠券按顺序生成数字图标。

### 5. Coupon 增强失败动画
- 新增 `func play_fail_bump()`：创建一个 tween，先 `position.x -= 40`（约 0.15s），再 `position.x += 40`（约 0.15s），使用 `Tween.TRANS_SINE` 或 `ELASTIC` 实现轻微回弹效果。

## 验证用例
- 启动 Battle：显示原价/特价标签；
- 点击满足条件的优惠券：CouponContainer显示序号，Battle新增一条 PriceLabel 文案为公式；
- 取消中间优惠券：Calculator 发出 `price_labels_rebuild` 与 `coupons_recalc_failed`；Battle 清除目标序号及后续标签并重建；CouponContainer 将失败及之后的优惠券回退为基础状态并重排图标；
- 点击不满足条件的优惠券：触发 `coupon_is_failed`，容器调用失败动画但不改变选择。

## 影响范围与兼容性
- 新增信号不破坏既有 `price_change` 监听（当前代码库未发现使用处）；
- PriceLabelMaker 的释放方法仅作用于其内部创建的标签；
- CouponContainer 的失败处理只影响当前选择数组与图标工厂。

## 需要确认
- 价格标签文案使用 `formula` 字符串（如 "10 - 5 = 5"）；是否需要额外前缀或本地化格式？
- 失败动画位移与时长参数是否采用 40px/0.15s，还是更明显/更轻微。